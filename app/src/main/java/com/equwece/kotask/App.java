/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package com.equwece.kotask;

import java.awt.Color;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.Optional;
import java.util.UUID;

import org.jdbi.v3.core.Jdbi;
import org.sqlite.SQLiteConfig;

import com.equwece.kotask.controller.TaskController;
import com.equwece.kotask.data.SqliteTagDao;
import com.equwece.kotask.data.SqliteTaskDao;
import com.equwece.kotask.data.Tag;
import com.equwece.kotask.data.TagDao;
import com.equwece.kotask.data.TaskDao;
import com.equwece.kotask.data.TaskItem;
import com.equwece.kotask.data.TaskItem.TaskStatus;
import com.equwece.kotask.view.AppWindow;
import com.formdev.flatlaf.FlatLaf;
import com.formdev.flatlaf.intellijthemes.FlatNordIJTheme;

public class App {
    /**
     * Create the GUI and show it. For thread safety,
     * this method should be invoked from the
     * event-dispatching thread.
     */
    private static void createAndShowGUI(AppEnv appEnv) {
        // Create and set up the window.
        AppWindow appWindow = new AppWindow(appEnv);
        appWindow.run();
    }

    public static Path setupAppDir() throws IOException {
        String userHome = System.getProperty("user.home");
        if (userHome == null) {
            throw new IOException("Can't get user's home directory");
        }
        Path appDirPath = Paths.get(userHome, ".KoTask");
        Files.createDirectories(appDirPath);
        return appDirPath;
    }

    public static void setupDB(Path appDirPath, Jdbi jdbi) {
        if (!appDirPath.resolve("cache.db").toFile().exists()) {
            jdbi.withHandle(handle -> {
                handle.execute(
                        "CREATE TABLE \"task\" ("
                                + "\"head_line\"	TEXT NOT NULL,"
                                + "\"description\"	TEXT,"
                                + "\"id\"	TEXT NOT NULL,"
                                + "\"status\" TEXT NOT NULL DEFAULT 'ACTIVE',"
                                + "\"creation_date\" TEXT NOT NULL,"
                                + "CONSTRAINT \"status_check\" CHECK(status IN ('ACTIVE','DONE')),"
                                + "PRIMARY KEY(\"id\"));");

                handle.execute(
                        "CREATE TABLE \"tag\" ("
                                + "\"title\" TEXT NOT NULL,"
                                + "\"color\" INT,"
                                + "PRIMARY KEY(\"title\"));");

                handle.execute(
                        "CREATE TABLE \"task_tag\" ("
                                + "\"task_id\" TEXT NOT NULL REFERENCES task(id) ON DELETE CASCADE,"
                                + "\"tag_title\" TEXT NOT NULL REFERENCES tag(title) ON DELETE CASCADE,"
                                + "PRIMARY KEY(\"task_id\", \"tag_title\"));");

                handle.execute(
                        "CREATE TABLE \"task_subtask\" ("
                                + "\"task_id\" TEXT NOT NULL REFERENCES task(id) ON DELETE CASCADE,"
                                + "\"subtask_id\" TEXT NOT NULL REFERENCES task(id) ON DELETE CASCADE,"
                                + "PRIMARY KEY(\"task_id\", \"subtask_id\"));");

                handle.createUpdate(
                        "INSERT INTO \"task\" (id, head_line, description, status, creation_date) "
                                + "VALUES (:id, :head_line, :description, :status, :creation_date)")
                        .bind("id", TaskController.ROOT_TASK_ID)
                        .bind("head_line", "root")
                        .bind("description", "root")
                        .bind("status", TaskStatus.ACTIVE)
                        .bind("creation_date", LocalDateTime.now().toString())
                        .execute();
                return null;
            });

        }
    }

    public static void main(String[] args) throws IOException, SQLException {

        Path appDirPath = setupAppDir();

        SQLiteConfig sqLiteConfig = new SQLiteConfig();
        sqLiteConfig.enforceForeignKeys(true); // Enable sqlite3 foreign key support
        Connection connection = DriverManager.getConnection(
                String.format("jdbc:sqlite:%s", appDirPath.resolve("cache.db").toString()),
                sqLiteConfig.toProperties());
        Jdbi jdbi = Jdbi.create(connection);

        jdbi.registerRowMapper(Tag.class,
                (rs, ctx) -> {
                    int tagColorRgb = rs.getInt("color");
                    Color tagColor = new Color(tagColorRgb);
                    return new Tag(Optional.of(tagColor), rs.getString("title"));
                });

        jdbi.registerRowMapper(TaskItem.class,
                (rs, ctx) -> {
                    String maybeDescription = rs.getString("description");
                    Optional<String> description;
                    if (maybeDescription == null) {
                        description = Optional.empty();
                    } else {
                        description = Optional.of(maybeDescription);
                    }

                    String taskStatusStr = rs.getString("status");
                    TaskStatus taskStatus;
                    switch (taskStatusStr) {
                        case "DONE":
                            taskStatus = TaskStatus.DONE;
                            break;
                        default:
                            taskStatus = TaskStatus.ACTIVE;
                            break;
                    }

                    String creationDateStr = rs.getString("creation_date");
                    LocalDateTime creationDate = LocalDateTime.parse(creationDateStr);

                    return new TaskItem(rs.getString("head_line"), UUID.fromString(rs.getString("id")),
                            description, taskStatus, creationDate, new ArrayList<>());
                });

        setupDB(appDirPath, jdbi);

        TaskDao taskDao = new SqliteTaskDao(jdbi);
        TagDao tagDao = new SqliteTagDao(jdbi);
        TaskController taskController = new TaskController(taskDao, tagDao);
        AppEnv appEnv = new AppEnv(taskDao, tagDao, taskController);

        // Schedule a job for the event-dispatching thread:
        // creating and showing this application's GUI.
        FlatLaf.registerCustomDefaultsSource("themes");
        FlatNordIJTheme.setup();
        // FlatOneDarkIJTheme.setup();
        javax.swing.SwingUtilities.invokeLater(new Runnable() {
            public void run() {
                createAndShowGUI(appEnv);
            }
        });
    }
}
